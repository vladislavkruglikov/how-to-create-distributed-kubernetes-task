services:
  dependencies:
    image: "kubernetes-pytorch-distributed-data-parallel-dependencies"
    build:
      context: "."
      target: "dependencies"

  development:
    image: "kubernetes-pytorch-distributed-data-parallel-development"
    build:
      context: "."
      target: "development"
    
    tty: True

    environment:
      - TORCH_DISTRIBUTED_BACKEND=gloo
      - TORCH_DISTRIBUTED_WORLD_SIZE=1
      - TORCH_DISTRIBUTED_RANK=0
      - TORCH_DISTRIBUTED_MASTER_ADDRESS=localhost
      - TORCH_DISTRIBUTED_MASTER_PORT=8000

    volumes:
      - ./source:/opt/source
  
  production:
    image: "kubernetes-pytorch-distributed-data-parallel-production"
    build:
      context: "."
      target: "production"
